# Сервер на Express для відображення статей

## Опис
Цей проєкт — сервер на **Node.js** з використанням **Express.js**, шаблонізатора **Pug**, а також системи авторизації через **JWT**.
Проєкт дозволяє переглядати список статей і користувачів, а також працювати з захищеними маршрутами для авторизованих користувачів.

## Функціонал
- Перегляд списку всіх статей (/articles) — з курсором
- Детальна сторінка окремої статті (/articles/:id)
- Перегляд статистики статей по авторам (/articles/stats) — агрегаційний запит
- Перегляд списку всіх користувачів (/users)
- Детальна сторінка окремого користувача (/users/:id)
- Керування темою сайту через cookie (/theme)
- Реєстрація та вхід користувачів через JWT (/auth_jwt)
- Доступ до захищених маршрутів для авторизованих користувачів

## Встановлення та запуск

1. Клонувати репозиторій:
   ```bash
   git clone <посилання-на-репозиторій>
   cd <папка-проєкту>
   
2. Встановити залежності:
   ```bash
   npm install
3. Створити .env файл у корені проєкту та додати:
   MONGO_URI=<твій MongoDB URI>
   DB=<назва бази даних>

4. 
* Запустити сервер:
   ```bash
   npm start
   
* Робота через докер:
Створити файл .env з наступними змінними:
  MONGO_URI=<ваш MongoDB URI>
  DB=PsyBalance
  JWT_SECRET=mySecretKey
Запустити Docker-контейнери:
  docker-compose up --build
Перевірити, що сервер працює:
Відкрити браузер: http://localhost:3000/dashboard
Або відправити GET-запит через Postman: http://localhost:3000/users

5. Відкрити в браузері:
http://localhost:3000/articles
http://localhost:3000/users
Users данні беруться з бази
6. Маршрути

**Користувачі**
| Метод | Шлях         | Опис                                                                               |
| ----- | ------------ | ---------------------------------------------------------------------------------- |
| GET   | `/users`     | Повертає список усіх користувачів                                                  |
| GET   | `/users/:id` | Повертає детальну інформацію про користувача за `id`                               |
| POST  | `/users`     | Створює нового користувача. Тіло запиту: `{ name, email, age, hobbies, password }` |


**Статті**
| Метод  | Шлях                    | Опис                                                                                  |
| ------ | ----------------------- | ------------------------------------------------------------------------------------- |
| GET    | `/articles`             | Повертає список усіх статей з полями title, author, createdAt (через курсор)        |
| GET    | `/articles/:id`         | Повертає одну статтю за її `id`                                                       |
| POST   | `/articles`             | Додає одну статтю. Тіло запиту: `{ title, content, author }`                          |
| POST   | `/articles/many`        | Додає кілька статей. Тіло запиту: `{ articles: [{ title, content, author }, ...] }`   |
| PUT    | `/articles/:id`         | Оновлює поля статті за допомогою `$set`. Тіло запиту: `{ title?, content?, author? }` |
| PUT    | `/articles/replace/:id` | Повністю замінює статтю. Тіло запиту: `{ title, content, author }`                    |
| DELETE | `/articles/:id`         | Видаляє одну статтю за `id`                                                           |
| DELETE | `/articles`             | Видаляє кілька статей за фільтром. Тіло запиту: `{ filter: {...} }`                   |

GET /articles/stats

Використовується агрегаційний pipeline для підрахунку кількості статей по автору:

[
{ $group: { _id: "$author", totalArticles: { $sum: 1 } } },
{ $sort: { totalArticles: -1 } }
]


Відповідь: HTML-сторінка з таблицею:
| Автор | Кількість статей |
|---------------|----------------|
| PsychologyBot | 12 |
| John Doe | 7 |


**Теми сайту (/theme)**
| Метод | URL                | Опис                              | Параметри / тіло запиту | Відповідь                                    |                                     |
| ----- | ------------------ | --------------------------------- | ----------------------- | -------------------------------------------- | ----------------------------------- |
| GET   | `/theme/get-theme` | Отримати поточну тему користувача | —                       | `{ theme: "light" }` або `{ theme: "dark" }` |                                     |
| POST  | `/theme/set-theme` | Встановити тему користувача       | \`{ theme: "light"      | "dark" }\`                                   | `{ message: "Theme set to light" }` |


Опис:
Теми зберігаються у cookie siteTheme.
GET повертає поточну тему.
POST встановлює нову тему та зберігає її в cookie з httpOnly: true і path: "/".


**/auth — реєстрація та вхід користувача через JWT**
| Метод | URL              | Опис                              | Параметри / тіло запиту | Відповідь                                              |
| ----- | ---------------- | --------------------------------- | ----------------------- | ------------------------------------------------------ |
| POST  | `/auth_jwt/register` | Реєстрація нового користувача     | `{ name, password }`    | `{ message: "User registered" }`                       |
| POST  | `/auth_jwt/login`    | Вхід користувача та генерація JWT | `{ name, password }`    | `{ token: "<JWT>" }` (і встановлюється cookie `token`) |

**/auth — реєстрація та вхід користувача через Passport**
| Метод | URL                       | Опис                | Відповідь                                                                                             |
| ----- | ------------------------- | ------------------- | ----------------------------------------------------------------------------------------------------- |
| GET   | `/auth_passport/login`    | Сторінка входу      | HTML-форма для логіну                                                                                 |
| POST  | `/auth_passport/login`    | Обробка логіну      | При успіху: редирект на `/secure_passport` <br> При невдачі: редирект назад на `/auth_passport/login` |
| GET   | `/auth_passport/register` | Сторінка реєстрації | HTML-форма для реєстрації                                                                             |
| POST  | `/auth_passport/register` | Обробка реєстрації  | При успіху: редирект на `/auth_passport/login`                                                        |


Опис:
Генерує JWT і зберігає його в cookie token з httpOnly: true.
Cookie використовується для авторизації захищених маршрутів.

Захищені маршрути
**JWT**
GET /secure_jwt/users — список користувачів
GET /secure_jwt/users/:id — детальна інформація про користувача
Доступ тільки з дійсним JWT у cookie token.

**Passport**
| Метод | URL                | Опис                                    |
| ----- | ------------------ | --------------------------------------- |
| GET   | `/secure_passport` | Сторінка для авторизованих користувачів |

## Технології

- **Node.js** — серверна платформа для запуску додатку
- **Express.js** — веб-фреймворк для створення REST API та маршрутизації
- **MongoDB** — документно-орієнтована база даних
- **Mongoose** — ODM для MongoDB, використовується для схем, валідації та CRUD-операцій
- **Pug** — шаблонізатор для сторінок користувачів та форм
- **EJS** — шаблонізатор для відображення списку та детальних сторінок статей
- **JWT (jsonwebtoken)** — авторизація через токени, збереження в cookie для захищених маршрутів
- **Passport** — локальна стратегія авторизації (для альтернативного входу/реєстрації)
- **bcrypt** — хешування паролів
- **express-session** — збереження сесій користувачів
- **cookie-parser** — робота з cookie (для теми сайту та JWT)



